name: Automated API tests using Postman CLI

on: push

jobs:
  automated-api-tests:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Postman CLI
        run: |
          powershell.exe -NoProfile -InputFormat None -ExecutionPolicy AllSigned -Command "[System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://dl-cli.pstmn.io/install/win64.ps1'))"

      - name: Login to Postman CLI
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      # Chạy API 1: GET /products (list + filter, sort, page)
      # Folder trong Collection: "List"
      # Data file: data\api1_products.csv
      - name: Run API 1 - List with CSV
        run: |
          postman collection run "47639393-49c88702-7f96-4d10-9f95-b22b69af8ffa" ^
            -e "47639393-351c31a9-629b-4d5c-be6c-32b53ffc26d2" ^
            -i "GET /products (list + filter, sort, page)"
            -d ".\api1_products.csv" ^
            --working-dir "%GITHUB_WORKSPACE%"

      # Chạy API 2: GET /products/{productId}
      # Folder: "Detail"
      # Data file: data\api2_products_productid.csv
      - name: Run API 2 - Detail with CSV
        run: |
          postman collection run "47639393-49c88702-7f96-4d10-9f95-b22b69af8ffa" ^
            -e "47639393-351c31a9-629b-4d5c-be6c-32b53ffc26d2" ^
            -i "GET /products/{productId}"
            -d ".\api2_products_productid.csv" ^
            --working-dir "%GITHUB_WORKSPACE%"

      # Chạy API 3: GET /products/search?q=
      # Folder: "Search"
      # Data file: data\api3_search.csv
      - name: Run API 3 - Search with CSV
        run: |
          postman collection run "47639393-49c88702-7f96-4d10-9f95-b22b69af8ffa" ^
            -e "47639393-351c31a9-629b-4d5c-be6c-32b53ffc26d2" ^
            -i "GET /products/search?q="
            -d ".\api3_search.csv" ^
            --working-dir "%GITHUB_WORKSPACE%"
